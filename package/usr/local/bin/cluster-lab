#!/bin/bash

# include common helper functions
. /usr/local/lib/cluster-lab/common

# include cluster-lab config
. /etc/cluster-lab/cluster.conf

# include cluster-lab functions
for sourcefile in /usr/local/lib/cluster-lab/*_lib; do
  . $sourcefile
done

usage () {
cat << EOM
usage:
        $0 start            Start the cluster lab.

        $0 stop             Stop the cluster lab.

EOM
}

function start(){
  pre_check_networking
  exit_with_message_on_error $? "Networking is broken"
  check_internet_connection

  # avahi
  pre_check_avahi
  configure_avahi
  systemctl restart avahi-daemon.service
  post_check_avahi

  configure_networking
  post_check_networking
  exit_with_message_on_error $? "Networking  broken"

  pre_check_dnsmasq
  # start additional services if cluster leader
  if [[ "$(get_current_leader_ip)" == "$(get_current_node_ip)" ]]; then
    add_leader_service_file
    post_check_avahi_leader_service

    configure_dnsmasq
    systemctl retstart dnsmasq.service
    post_check_dnsmasq
  fi

}

function stop(){
  delete_cluster_leader_service_file
  pre_check_cluster_leader_service

  reset_avahi
  systemctl restart avahi-daemon.service
  pre_check_avahi

  reset_dnsmasq
  systemctl retstart dnsmasq.service
  pre_check_dnsmasq

  reset_networking
  pre_check_networking
  check_internet_connection
}

if [ $# -eq 1 ]; then
    case "$1" in
        "start" )
            start
            ;;
        "stop" )
            stop
            ;;
        * )
        if [[ $DEBUG == "true" ]]; then
            "$@"
        else
            usage
        fi
            ;;
    esac
else
    usage
fi
