#!/bin/bash

# include common helper functions
. /usr/local/lib/cluster-lab/common

# include cluster-lab config
. /etc/cluster-lab/cluster.conf

# include cluster-lab functions
for sourcefile in /usr/local/lib/cluster-lab/*_lib; do
  . $sourcefile
done
# libs="networking_lib avahi_lib dnsmasq_lib docker_lib"
# for sourcefile in ${libs}; do
#   . /usr/local/lib/cluster-lab/$sourcefile
# done

usage () {
cat << EOM
usage:
        $0 start            Start the cluster lab.

        $0 stop             Stop the cluster lab.

EOM
}

function start(){
  pre_check_networking
  exit_with_message_on_error $? "Networking is broken"
  check_internet_connection

  configure_networking

  post_check_networking
  exit_with_message_on_error $? "Networking  broken"

  pre_check_dnsmasq
  # start additional services if cluster leader
  if [[ "${VLAN_LEADER_IP}" == "$(get_current_node_ip)" ]]; then
    configure_dnsmasq
    systemctl restart dnsmasq.service
#    echo "waiting 2 secs for restart of dnsmasq"
    sleep 2
    post_check_dnsmasq
  fi

}

function stop(){
  delete_cluster_leader_service
  pre_check_cluster_leader_service

  reset_avahi
  systemctl restart avahi-daemon.service
#  echo "waiting 2 secs for restart of avahi-daemon"
  sleep 2
  pre_check_avahi

  reset_dnsmasq
  systemctl restart dnsmasq.service
#  echo "waiting 2 secs for restart of dnsmasq"
  sleep 2
  pre_check_dnsmasq

  reset_networking
  pre_check_networking
  check_internet_connection
}

if [ $# -eq 1 ]; then
    case "$1" in
        "start" )
            start
            ;;
        "stop" )
            stop
            ;;
        * )
            ;;
    esac
elif [[ $DEBUG == "true" ]]; then
  eval "$@"
else
  usage
fi
